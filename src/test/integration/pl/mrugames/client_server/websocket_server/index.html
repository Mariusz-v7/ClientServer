<html>
<head>
</head>
<body>
<h1>WebSocket Test</h1>

<script>
        var wsList = [];
        var amount = 100;

        for (var i = 0; i < amount; ++i) {
            var ws = {
                id: i,
                socket: new WebSocket('ws://localhost:10002'),
                name: 'socket ' + i,
                sentAmount: 0,
                receivedAmount: 0,
                sendInterval: 250 + 25 * i,
                lastDuration: -1,
                avgDuration: -1,
                lastSent: null,
            };
//todo: table will be better!
            document.body.innerHTML += '<div id="s' + i + '"><b>' + ws.name + ':</b> messages sent: <span id="sent-' + i + '">0</span>, messages received: <span id="received-' + i + '">0</span>, last duration: <span id="duration-' + i + '"></span>, avg: <span id="avg-duration-' + i + '"></span></div>';

            wsList.push(ws);
        }

        setTimeout(function() {
            wsList.forEach(function(socket) {

                socket.socket.onmessage = function(m) {
                    var now = new Date();

                    socket.lastDuration = now.getTime() - socket.lastSent.getTime();

                    if (socket.avgDuration !== -1) {
                        socket.avgDuration *= socket.receivedAmount;
                    }

                    socket.avgDuration += socket.lastDuration;
                    socket.avgDuration /= socket.receivedAmount + 1;

                    document.getElementById('duration-' + socket.id).innerHTML = socket.lastDuration + ' ms';
                    document.getElementById('avg-duration-' + socket.id).innerHTML = Math.round(socket.avgDuration * 100)/100 + ' ms';

                    ++socket.receivedAmount;
                    document.getElementById('received-' + socket.id).innerHTML = socket.receivedAmount;
                };

                setInterval(function() {
                    if (socket.socket.readyState !== 1) {
                        return;
                    }

                    ++socket.sentAmount;

                    socket.lastSent = new Date();

                    socket.socket.send('message ' + socket.sentAmount);

                    document.getElementById('sent-' + socket.id).innerHTML = socket.sentAmount;
                }, socket.sendInterval);
            });
        }, 500);








</script>
</body>
</html>
